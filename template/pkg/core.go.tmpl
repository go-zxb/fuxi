package core

import (
	"fmt"
	"github.com/gin-gonic/gin"
	"github.com/spf13/cobra"
	"{{.ModuleName}}/config"
	"{{.ModuleName}}/middleware"
	"{{.ModuleName}}/core/data"
	_ "app/docs/openapi"
	swagFiles "github.com/swaggo/files"
  ginSwag "github.com/swaggo/gin-swagger"
	"log"
)

var GinServerCmd = &cobra.Command{
	Use:   "server",
	Short: "server",
	Long:  "server",
	Run:   Start,
}

var configPath string

func init() {
	GinServerCmd.Flags().StringVarP(&configPath, "config", "c", "config/config.yaml", "config file path")
}

type App struct {}

func NewApp() *App {
	return &App{}
}

// åˆå§‹åŒ–é…ç½®
func (a *App) initConf() *GinServer {
  // åˆå§‹åŒ–é…ç½®
	c, err := config.NewConfig(configPath)
	if err != nil {
		log.Fatalln("â åˆå§‹åŒ–é…ç½®å¤±è´¥:",err)
	}
	//åˆå§‹åŒ–æ•°æ®åº“
	_,err = data.InitMysql(*c)
  if err != nil {
    log.Fatalln("â åˆå§‹åŒ–MySQLæ•°æ®åº“å¤±è´¥:",err)
  }
  log.Println("âœ… åˆå§‹åŒ–MySQLæˆåŠŸğŸ†—")
  //åˆå§‹åŒ–redis
  	_, err = data.InitRedis(*c)
  	if err != nil {
  		log.Fatalln("â åˆå§‹åŒ–rediså¤±è´¥:", err)
  	}
  	log.Println("âœ… åˆå§‹åŒ–RedisæˆåŠŸğŸ†—")
  return &GinServer{c: c}
}

type GinServer struct {
	c *config.Config
}

// å¯åŠ¨æœåŠ¡
func (d *GinServer) initGinServer()  {
	engine := gin.Default()
	engine.Use(middleware.Cors())
	InitRouter(engine)
	engine.GET("/openapi/*any", ginSwag.WrapHandler(swagFiles.Handler))
	if err := engine.Run(fmt.Sprintf("%s:%d", d.c.Gin.Host, d.c.Gin.Port));err != nil {
  		log.Fatalln("â æœåŠ¡å¯åŠ¨å¤±è´¥:", err)
  	}
}

func InitRouter(engine *gin.Engine) {

}

func Start(cmd *cobra.Command, args []string) {
	NewApp().initConf().initGinServer()
}
