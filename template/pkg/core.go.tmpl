package core

import (
	"fmt"
	"context"
	"errors"
	"time"
	"os"
	"os/signal"
  "syscall"
  "net/http"
	"github.com/gin-gonic/gin"
	"github.com/spf13/cobra"
	"{{.ModuleName}}/config"
	"{{.ModuleName}}/middleware"
	"{{.ModuleName}}/core/data"
	_ "{{.ModuleName}}/docs/openapi"
	swagFiles "github.com/swaggo/files"
  ginSwag "github.com/swaggo/gin-swagger"
	"log"
)

var GinServerCmd = &cobra.Command{
	Use:   "server",
	Short: "server",
	Long:  "server",
	Run:   Start,
}

var configPath string

func init() {
	GinServerCmd.Flags().StringVarP(&configPath, "config", "c", "config/config.yaml", "config file path")
}

type App struct {}

func NewApp() *App {
	return &App{}
}

// åˆå§‹åŒ–é…ç½®
func (a *App) initConf() *GinServer {
  // åˆå§‹åŒ–é…ç½®
	c, err := config.NewConfig(configPath)
	if err != nil {
		log.Fatalln("â åˆå§‹åŒ–é…ç½®å¤±è´¥:",err)
	}
	//åˆå§‹åŒ–æ•°æ®åº“
	_,err = data.InitMysql(*c)
  if err != nil {
    log.Fatalln("â åˆå§‹åŒ–MySQLæ•°æ®åº“å¤±è´¥:",err)
  }
  log.Println("âœ… åˆå§‹åŒ–MySQLæˆåŠŸğŸ†—")
  //åˆå§‹åŒ–redis
  	_, err = data.InitRedis(*c)
  	if err != nil {
  		log.Fatalln("â åˆå§‹åŒ–rediså¤±è´¥:", err)
  	}
  	log.Println("âœ… åˆå§‹åŒ–RedisæˆåŠŸğŸ†—")
  return &GinServer{c: c}
}

type GinServer struct {
	c *config.Config
}

// å¯åŠ¨æœåŠ¡
func (d *GinServer) initGinServer()  {
	engine := gin.Default()
	engine.Use(middleware.Cors())
	InitRouter(engine)
	engine.GET("/openapi/*any", ginSwag.WrapHandler(swagFiles.Handler))
  go func() {
      time.Sleep(time.Millisecond * 500)
      addr := fmt.Sprintf("http://%s:%d/openapi/index.html", d.c.Gin.Host, d.c.Gin.Port)
      if d.c.Gin.Host == "0.0.0.0" {
        addr = fmt.Sprintf("http://127.0.0.1:%d/openapi/index.html", d.c.Gin.Port)
      }
      fmt.Println("ğŸ’»ğŸ“’", " openapi api æ–‡æ¡£åœ°å€ï¼š", addr)
    }()
  // å¯åŠ¨ Gin æœåŠ¡
  	srv := &http.Server{
  		Addr:    fmt.Sprintf("%s:%d", d.c.Gin.Host, d.c.Gin.Port),
  		Handler: engine,
  	}

  	go func() {
  		if err := srv.ListenAndServe(); err != nil && !errors.Is(err, http.ErrServerClosed) {
  				fmt.Println("â æœåŠ¡å¯åŠ¨å¤±è´¥:", err)
  				os.Exit(1)
  		}
  	}()

  	// æ•è· SIGINT ä¿¡å·
    	quit := make(chan os.Signal, 1)
    	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
    	<-quit
    	log.Println("å…³é—­æœåŠ¡ä¸­...")

    	// ä¼˜é›…å…³é—­æœåŠ¡
    	if err := srv.Shutdown(context.Background()); err != nil {
    		log.Fatal("æœåŠ¡å·²è¢«è¿«å…³é—­:", err)
    	}

    	log.Println("æœåŠ¡å·²é€€å‡º")
}

func InitRouter(engine *gin.Engine) {

}

func Start(cmd *cobra.Command, args []string) {
	NewApp().initConf().initGinServer()
}
